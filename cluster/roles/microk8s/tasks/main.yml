---

- name: Install microk8s
  snap:
    channel: "{{ microk8s_snap_channel }}"
    name: microk8s
    classic: true
    state: present
  tags: [ microk8s, install ]

- name: Add the root user to the microk8s group
  user:
    name: root
    append: true
    groups: microk8s
  tags: [ microk8s, config ]

- name: Alias microk8s.kubectl to kubectl
  lineinfile:
    create: true
    path: /root/.bash_profile
    regexp: '^alias kubectl='
    line: 'alias kubectl="microk8s.kubectl"'
    owner: root
    group: root
    mode: 0600
    state: present
  tags: [ microk8s, config ]

- name: Configure kubelet hostname
  lineinfile:
    path: /var/snap/microk8s/current/args/kubelet
    regexp: '^--hostname-override[ =]'
    line: --hostname-override={{ inventory_hostname }}
  notify: Restart kubelet
  tags: [ microk8s, config ]

- name: Configure kubelet labels
  lineinfile:
    path: /var/snap/microk8s/current/args/kubelet
    regexp: '^--node-labels='
    line: --node-labels="microk8s.io/cluster=true,type={{ k8s_node_type }}"
  notify: Restart kubelet
  tags: [ microk8s, config ]